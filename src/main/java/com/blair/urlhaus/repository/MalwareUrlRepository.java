package com.blair.urlhaus.repository;

import com.blair.urlhaus.domain.MalwareUrl;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

import javax.sql.DataSource;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@Repository
public class MalwareUrlRepository {
    private NamedParameterJdbcTemplate jdbcTemplate;
    private ObjectMapper objectMapper;

    public MalwareUrlRepository(DataSource dataSource, ObjectMapper objectMapper) {
        jdbcTemplate = new NamedParameterJdbcTemplate(dataSource);
        this.objectMapper = objectMapper;
    }

    public List<MalwareUrl> get(int limit, int offset) {
        MapSqlParameterSource sps = new MapSqlParameterSource()
                .addValue("limit", limit)
                .addValue("offset", offset);

        return jdbcTemplate.query(GET, sps, this::mapRow);
    }

    private MalwareUrl mapRow(ResultSet resultSet, int i) throws SQLException {
        try {
            return new MalwareUrl(
                    resultSet.getInt("id"),
                    LocalDateTime.parse(resultSet.getString("date_added"), DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")),
                    resultSet.getString("url"),
                    resultSet.getString("url_status"),
                    resultSet.getString("threat"),
                    objectMapper.readValue(resultSet.getString("tags"), new TypeReference<>() {}),
                    resultSet.getString("url_haus_link"),
                    resultSet.getString("reporter")
            );
        } catch (JsonProcessingException jpe) {
            throw new RuntimeException();
        }
    }

    private static final String GET =
            "SELECT id, TO_CHAR(date_added, 'YYYY-MM-DD HH:MI:SS') AS date_added, url, url_status, threat, tags, url_haus_link, reporter " +
                    "FROM url_haus.url_entry " +
                    "ORDER BY date_added DESC " +
                    "LIMIT :limit OFFSET :offset";
}
